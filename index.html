<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>医療GS1 撮影解析モード</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#f4f6f9;
}
.container{
  max-width:600px;
  margin:auto;
  padding:16px;
}
.card{
  background:white;
  padding:16px;
  border-radius:16px;
  box-shadow:0 6px 20px rgba(0,0,0,0.08);
}
video,canvas{
  width:100%;
  border-radius:12px;
  background:black;
  margin-top:10px;
}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:12px;
  font-size:16px;
}
.primary{background:#007aff;color:white;}
.status{
  margin-top:10px;
  font-weight:bold;
}
.result{
  margin-top:10px;
  word-break:break-all;
  font-size:14px;
}
</style>
</head>
<body>

<div class="container">
<h2>医療GS1 撮影解析モード</h2>

<div class="card">

<button class="primary" onclick="startCamera()">カメラ起動</button>
<button class="primary" onclick="capturePhoto()">撮影して解析</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div class="status" id="status"></div>
<div class="result" id="result"></div>

</div>
</div>

<script type="module">

import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/+esm";

let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let statusEl = document.getElementById("status");
let resultEl = document.getElementById("result");

let stream = null;
let reader = new BrowserMultiFormatReader();

window.startCamera = async function(){

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:{ ideal:"environment" },
        width:{ ideal:1920 },
        height:{ ideal:1080 }
      },
      audio:false
    });

    video.srcObject = stream;
    statusEl.innerText = "カメラ起動完了";
  }
  catch(e){
    alert("カメラ起動失敗：" + e);
  }
};

window.capturePhoto = async function(){

  if(!stream){
    alert("先にカメラを起動してください");
    return;
  }

  statusEl.innerText = "撮影中...";

  const context = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  context.drawImage(video,0,0);

  // 前処理
  preprocessImage(context, canvas.width, canvas.height);

  statusEl.innerText = "解析中...";

  try{

    // 1回目
    let result = await reader.decodeFromCanvas(canvas);

    handleResult(result.getText());
    return;

  }catch{}

  // 回転して再試行
  try{
    rotateCanvas(context, canvas);
    let result = await reader.decodeFromCanvas(canvas);
    handleResult(result.getText());
    return;
  }catch{}

  alert("バーコードを読み取れませんでした");
  statusEl.innerText = "失敗";
};

function preprocessImage(ctx,width,height){

  let imageData = ctx.getImageData(0,0,width,height);
  let data = imageData.data;

  for(let i=0;i<data.length;i+=4){

    let r=data[i];
    let g=data[i+1];
    let b=data[i+2];

    // グレースケール
    let gray=(r+g+b)/3;

    // コントラスト強化
    gray = gray > 128 ? 255 : 0;

    data[i]=data[i+1]=data[i+2]=gray;
  }

  ctx.putImageData(imageData,0,0);
}

function rotateCanvas(ctx,canvas){

  let temp=document.createElement("canvas");
  temp.width=canvas.height;
  temp.height=canvas.width;

  let tctx=temp.getContext("2d");
  tctx.translate(temp.width/2,temp.height/2);
  tctx.rotate(Math.PI/2);
  tctx.drawImage(canvas,-canvas.width/2,-canvas.height/2);

  canvas.width=temp.width;
  canvas.height=temp.height;

  ctx.drawImage(temp,0,0);
}

function handleResult(text){

  resultEl.innerText = text;

  const parsed = parseGS1(text);

  if(!parsed){
    alert("医療用GS1ではありません");
    statusEl.innerText="非対応コード";
    return;
  }

  statusEl.innerText="医療GS1検出成功";

  alert("GTIN:"+parsed.gtin+"\n有効期限:"+parsed.expiry);
}

function parseGS1(text){

  const gtin=text.match(/\(01\)(\d{14})/);
  const exp=text.match(/\(17\)(\d{6})/);

  if(!gtin||!exp){
    return null;
  }

  const year="20"+exp[1].substring(0,2);
  const month=exp[1].substring(2,4);
  const day=exp[1].substring(4,6);

  return{
    gtin:gtin[1],
    expiry:`${year}-${month}-${day}`
  };
}

</script>
</body>
</html>
