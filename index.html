<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>医療GS1在庫テスト</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#f2f4f8;
}
.container{
  max-width:600px;
  margin:auto;
  padding:16px;
}
.card{
  background:white;
  padding:16px;
  border-radius:16px;
  box-shadow:0 6px 20px rgba(0,0,0,0.08);
}
video{
  width:100%;
  border-radius:12px;
  background:black;
}
.scan-frame{
  position:absolute;
  top:50%;
  left:50%;
  width:60%;
  height:120px;
  transform:translate(-50%,-50%);
  border:3px solid #00c853;
  border-radius:12px;
  pointer-events:none;
}
.video-wrapper{
  position:relative;
}
button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:12px;
  font-size:16px;
}
.primary{background:#007aff;color:white;}
.danger{background:#ff3b30;color:white;}
.status{
  margin-top:10px;
  font-weight:bold;
}
</style>
</head>
<body>

<div class="container">
<h2>医療GS1 在庫管理</h2>

<div class="card">

<label><input type="radio" name="mode" value="save" checked> 保存モード</label>
<label><input type="radio" name="mode" value="search"> 検索モード</label>

<div class="video-wrapper">
<video id="video" playsinline></video>
<div class="scan-frame"></div>
</div>

<button class="primary" onclick="toggleCamera()">カメラ ON / OFF</button>

<div class="status" id="status"></div>

</div>
</div>

<script type="module">
import {
  BrowserMultiFormatReader
} from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/+esm";

let reader = new BrowserMultiFormatReader();
let controls = null;
let isCameraOn = false;

const video = document.getElementById("video");
const statusEl = document.getElementById("status");

window.toggleCamera = async function(){

  if(isCameraOn){
    stopCamera();
    return;
  }

  try{

    statusEl.innerText="カメラ起動中...";

    controls = await reader.decodeFromConstraints(
      {
        audio:false,
        video:{
          facingMode:{ exact:"environment" }, // 外カメ固定
          width:{ ideal:1280 },
          height:{ ideal:720 }
        }
      },
      video,
      (result, err)=>{
        if(result){
          handleScan(result.getText());
        }
      }
    );

    isCameraOn = true;
    statusEl.innerText="スキャン待機中（枠内にバーコード）";

  }catch(e){
    alert("外カメ取得失敗。内カメで再試行します。");
    fallbackCamera();
  }
};

async function fallbackCamera(){
  controls = await reader.decodeFromConstraints(
    { video:true },
    video,
    (result, err)=>{
      if(result){
        handleScan(result.getText());
      }
    }
  );
  isCameraOn = true;
}

function stopCamera(){
  if(controls){
    controls.stop();
    controls=null;
  }
  video.srcObject=null;
  isCameraOn=false;
  statusEl.innerText="停止中";
}

function handleScan(text){

  const parsed = parseGS1(text);

  if(!parsed){
    alert("医療用GS1コードではありません");
    return;
  }

  stopCamera();

  const mode=document.querySelector("input[name='mode']:checked").value;

  if(mode==="save"){
    saveData(parsed);
  }else{
    searchData(parsed);
  }
}

function parseGS1(text){

  const gtin=text.match(/\(01\)(\d{14})/);
  const exp=text.match(/\(17\)(\d{6})/);

  if(!gtin||!exp){
    return null;
  }

  const year="20"+exp[1].substring(0,2);
  const month=exp[1].substring(2,4);
  const day=exp[1].substring(4,6);

  return{
    gtin:gtin[1],
    expiry:`${year}-${month}-${day}`
  };
}

function saveData(data){
  let db=JSON.parse(localStorage.getItem("medicalDB")||"[]");
  db.push(data);
  localStorage.setItem("medicalDB",JSON.stringify(db));
  alert("保存完了\n"+data.gtin+"\n期限:"+data.expiry);
}

function searchData(data){
  let db=JSON.parse(localStorage.getItem("medicalDB")||"[]");
  const matches=db.filter(d=>d.gtin===data.gtin);

  if(matches.length===0){
    alert("該当なし");
    return;
  }

  const sorted=[...matches].sort((a,b)=>a.expiry.localeCompare(b.expiry));
  const earliest=sorted[0];

  if(confirm("最短期限:"+earliest.expiry+"\n今回:"+data.expiry+"\n削除しますか？")){
    const idx=db.findIndex(d=>d.gtin===data.gtin&&d.expiry===data.expiry);
    if(idx!==-1){
      db.splice(idx,1);
      localStorage.setItem("medicalDB",JSON.stringify(db));
      alert("削除しました");
    }
  }
}
</script>

</body>
</html>
