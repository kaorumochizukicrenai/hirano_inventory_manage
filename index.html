<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>医療バーコードSPA</title>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#f4f6f9;}
header{background:#007aff;color:white;padding:12px;text-align:center;font-size:18px;}
.container{padding:16px;}
button{width:100%;padding:14px;margin:8px 0;border:none;border-radius:12px;font-size:16px;background:#007aff;color:white;}
.secondary{background:#666;}
.card{background:white;padding:16px;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
video{width:100%;border-radius:12px;background:black;margin-top:10px;}
input,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;}
.item{border-bottom:1px solid #eee;padding:8px 0;}
.hidden{display:none;}
</style>
</head>
<body>

<header>医療バーコード管理</header>
<div class="container">

<div id="home">
<button onclick="showPage('view')">データ閲覧</button>
<button onclick="showPage('save')">バーコード保存</button>
<button onclick="showPage('search')">バーコード照会</button>
<button onclick="showPage('api')">API情報</button>
</div>

<div id="view" class="hidden card">
<h3>保存データ一覧</h3>
<div id="dataList"></div>
<button class="secondary" onclick="showPage('home')">戻る</button>
</div>

<div id="save" class="hidden card">
<h3>バーコード保存</h3>
<video id="videoSave" autoplay playsinline></video>
<button onclick="captureAndSend('save')">読み取り</button>
<div id="saveResult"></div>
<button class="secondary" onclick="showPage('home')">戻る</button>
</div>

<div id="search" class="hidden card">
<h3>バーコード照会</h3>
<video id="videoSearch" autoplay playsinline></video>
<button onclick="captureAndSend('search')">読み取り</button>
<div id="searchResult"></div>
<button class="secondary" onclick="showPage('home')">戻る</button>
</div>

<div id="api" class="hidden card">
<h3>Gemini API設定</h3>
<label>APIキー</label>
<input id="apiKey">
<label>プロンプト</label>
<textarea id="prompt" rows="5"></textarea>
<button onclick="saveAPI()">保存</button>
<button class="secondary" onclick="showPage('home')">戻る</button>
</div>

<canvas id="canvas" class="hidden"></canvas>

</div>

<script>
let currentStream=null;
let memoryDB=[];

function showPage(page){

document.querySelectorAll(".card,#home").forEach(el=>el.classList.add("hidden"));
document.getElementById(page).classList.remove("hidden");

if(page==="save") startCamera("videoSave");
if(page==="search") startCamera("videoSearch");
if(page==="home"){ stopCamera(); }

if(page==="view"){ renderData(); }

}

async function startCamera(videoId){
stopCamera();
currentStream=await navigator.mediaDevices.getUserMedia({
video:{facingMode:{ideal:"environment"},width:{ideal:1920},height:{ideal:1080}},
audio:false
});
document.getElementById(videoId).srcObject=currentStream;
}

function stopCamera(){
if(currentStream){
currentStream.getTracks().forEach(t=>t.stop());
currentStream=null;
}
}

async function captureAndSend(mode){

let video=document.getElementById(mode==="save"?"videoSave":"videoSearch");
let canvas=document.getElementById("canvas");
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
let ctx=canvas.getContext("2d");
ctx.drawImage(video,0,0);

let base64=canvas.toDataURL("image/jpeg").split(",")[1];

let apiKey=localStorage.getItem("gemini_key");
let prompt=localStorage.getItem("gemini_prompt");

if(!apiKey||!prompt){alert("API情報未設定");return;}

let res=await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
contents:[{
parts:[
{text:prompt},
{inline_data:{mime_type:"image/jpeg",data:base64}}
]
}]
})
});

let json=await res.json();

try{
let text=json.candidates[0].content.parts[0].text;
let data=JSON.parse(text);
handleResult(data,mode);
}catch(e){
alert("解析失敗");
}

}

function handleResult(data,mode){

if(data.type!=="医療"||!data.productType||!data.expiry){
alert("医療バーコードではありません");
return;
}

if(mode==="save"){
memoryDB.push(data);
document.getElementById("saveResult").innerText="保存成功："+data.productType+" "+data.expiry;
}

if(mode==="search"){

let same=memoryDB.filter(d=>d.productType===data.productType);
if(same.length===0){alert("該当なし");return;}

same.sort((a,b)=>a.expiry.localeCompare(b.expiry));
let nearest=same[0];

let exactIndex=memoryDB.findIndex(d=>d.productType===data.productType&&d.expiry===data.expiry);

let html="最短期限："+nearest.expiry+"<br>";

if(exactIndex!==-1){
html+="<button onclick='consume("+exactIndex+")'>今回分を使用済みにする</button>";
}

document.getElementById("searchResult").innerHTML=html;
}

}

function consume(index){
memoryDB.splice(index,1);
alert("削除しました");
renderData();
}

function renderData(){
let el=document.getElementById("dataList");
el.innerHTML="";
memoryDB.forEach((d,i)=>{
el.innerHTML+=`<div class="item">${d.productType} - ${d.expiry}
<button onclick="consume(${i})">削除</button></div>`;
});
}

function saveAPI(){
localStorage.setItem("gemini_key",document.getElementById("apiKey").value);
localStorage.setItem("gemini_prompt",document.getElementById("prompt").value);
alert("保存しました");
}

document.getElementById("apiKey").value=localStorage.getItem("gemini_key")||"";
document.getElementById("prompt").value=localStorage.getItem("gemini_prompt")||"";

showPage("home");
</script>

</body>
</html>
