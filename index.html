<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GS1 医療用 DataBar対応ツール</title>

<script type="module">
import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.1/+esm";

const reader = new BrowserMultiFormatReader();
let cameraActive = false;
let db = JSON.parse(localStorage.getItem("gs1db") || "[]");

function saveDB(){
  localStorage.setItem("gs1db", JSON.stringify(db));
}

function validDateYYMMDD(v){
  if(!/^\d{6}$/.test(v)) return false;
  let y=2000+parseInt(v.slice(0,2));
  let m=parseInt(v.slice(2,4));
  let d=parseInt(v.slice(4,6));
  let date=new Date(y,m-1,d);
  return date.getFullYear()===y &&
         date.getMonth()===m-1 &&
         date.getDate()===d;
}

function parseGS1(data){
  let cleaned=data.replace(/\x1D/g,"");
  let gtinMatch=cleaned.match(/01(\d{14})/);
  let expMatch=cleaned.match(/17(\d{6})/);
  return{
    gtin:gtinMatch?gtinMatch[1]:null,
    expiry:expMatch?expMatch[1]:null
  };
}

function formatExpiry(e){
  return "20"+e.slice(0,2)+"-"+e.slice(2,4)+"-"+e.slice(4,6);
}

function handleScan(text){
  const parsed=parseGS1(text);

  if(!parsed.gtin || !parsed.expiry){
    alert("医療用GS1 (01)+(17) を含むDataBarではありません。");
    return;
  }

  if(!validDateYYMMDD(parsed.expiry)){
    alert("有効期限フォーマット不正");
    return;
  }

  const gtin=parsed.gtin;
  const expiry=formatExpiry(parsed.expiry);
  const mode=document.getElementById("modeSelect").value;

  if(mode==="save"){
    db.push({gtin,expiry});
    saveDB();
    output.innerHTML=`保存完了<br>GTIN: ${gtin}<br>期限: ${expiry}`;
  }

  if(mode==="search"){
    let matches=db.filter(x=>x.gtin===gtin);
    if(matches.length===0){
      output.innerHTML="該当在庫なし";
      return;
    }
    let earliest=matches.reduce((a,b)=>a.expiry<b.expiry?a:b);
    output.innerHTML=
      `該当件数: ${matches.length}<br>
       最短期限: ${earliest.expiry}<br><br>
       <button class="danger" onclick="deleteCurrent('${gtin}','${expiry}')">
       今読んだ期限を削除</button>`;
  }
}

window.deleteCurrent=function(gtin,expiry){
  let index=db.findIndex(x=>x.gtin===gtin && x.expiry===expiry);
  if(index>=0){
    db.splice(index,1);
    saveDB();
    alert("削除しました");
  }else{
    alert("該当データなし");
  }
}

window.startCamera=async function(){
  cameraActive=true;
  document.getElementById("cameraBtn").innerText="カメラ OFF";
  document.getElementById("video").style.display="block";

  const devices=await reader.listVideoInputDevices();
  const deviceId=devices[0].deviceId;

  reader.decodeFromVideoDevice(deviceId,"video",(result,err)=>{
    if(result){
      handleScan(result.getText());
    }
  });
}

window.stopCamera=function(){
  reader.reset();
  cameraActive=false;
  document.getElementById("cameraBtn").innerText="カメラ ON";
  document.getElementById("video").style.display="none";
}

window.toggleCamera=function(){
  cameraActive?stopCamera():startCamera();
}
</script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f4f6fb;
  display:flex;
  justify-content:center;
  padding:20px;
}
.container{
  width:100%;
  max-width:520px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
}
h1{
  font-size:20px;
  margin-bottom:15px;
}
select,button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-top:10px;
  font-size:14px;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:hover{opacity:0.9;}
button.danger{background:#dc2626;}
video{
  width:100%;
  margin-top:15px;
  border-radius:12px;
}
.result{
  margin-top:15px;
  font-size:14px;
}
</style>
</head>

<body>
<div class="container">
<div class="card">

<h1>GS1 DataBar 医療用ツール</h1>

<select id="modeSelect">
<option value="save">データ保存モード</option>
<option value="search">検索モード</option>
</select>

<button id="cameraBtn" onclick="toggleCamera()">カメラ ON</button>

<video id="video" style="display:none;"></video>

<div class="result" id="output"></div>

</div>
</div>
</body>
</html>
