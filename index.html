<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>GS1 調剤薬局ツール</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<style>
body {
  font-family: sans-serif;
  margin: 20px;
}
h1 {
  margin-bottom: 10px;
}
#reader {
  width: 100%;
  max-width: 400px;
  border: 1px solid #ccc;
}
button {
  margin: 5px 0;
  padding: 10px;
  width: 200px;
}
.mode {
  font-weight: bold;
  margin-bottom: 10px;
}
.result {
  margin-top: 10px;
  padding: 10px;
  background: #f3f3f3;
}
</style>
</head>
<body>

<h1>GS1バーコードツール</h1>

<div class="mode">
現在のモード：
<select id="modeSelect">
  <option value="save">データ保存モード</option>
  <option value="search">検索モード</option>
</select>
</div>

<div id="reader"></div>

<div class="result" id="output"></div>

<script>
let db = JSON.parse(localStorage.getItem("gs1db") || "[]");

function saveDB() {
  localStorage.setItem("gs1db", JSON.stringify(db));
}

// GS1解析
function parseGS1(data) {
  let gtin = null;
  let expiry = null;

  if (data.includes("(01)")) {
    gtin = data.match(/\(01\)(\d{14})/)?.[1];
  } else if (data.startsWith("01")) {
    gtin = data.substring(2, 16);
  }

  if (data.includes("(17)")) {
    expiry = data.match(/\(17\)(\d{6})/)?.[1];
  } else {
    let match = data.match(/17(\d{6})/);
    if (match) expiry = match[1];
  }

  return { gtin, expiry };
}

function formatExpiry(e) {
  if (!e) return "";
  return "20" + e.substring(0,2) + "-" + e.substring(2,4) + "-" + e.substring(4,6);
}

function handleScan(code) {
  let mode = document.getElementById("modeSelect").value;
  let parsed = parseGS1(code);

  let gtin = parsed.gtin;
  let expiry = parsed.expiry;

  if (!gtin) {
    gtin = prompt("GTINが読み取れません。入力してください（14桁）");
  }
  if (!expiry) {
    expiry = prompt("使用期限が読み取れません。入力してください（YYMMDD）");
  }

  if (!gtin || !expiry) {
    alert("入力が不完全です。");
    return;
  }

  expiry = formatExpiry(expiry);

  if (mode === "save") {
    db.push({ gtin, expiry });
    saveDB();
    document.getElementById("output").innerHTML =
      "保存しました<br>GTIN: " + gtin + "<br>期限: " + expiry;
  }

  if (mode === "search") {
    let matches = db.filter(x => x.gtin === gtin);
    if (matches.length === 0) {
      document.getElementById("output").innerHTML = "該当商品なし";
      return;
    }

    let earliest = matches.reduce((a,b)=> a.expiry < b.expiry ? a : b);

    document.getElementById("output").innerHTML =
      "該当件数: " + matches.length + "<br>" +
      "最短期限: " + earliest.expiry + "<br><br>" +
      "<button onclick='deleteCurrent(\""+gtin+"\",\""+expiry+"\")'>今読んだ期限データを削除</button>";
  }
}

function deleteCurrent(gtin, expiry) {
  let index = db.findIndex(x => x.gtin===gtin && x.expiry===expiry);
  if (index >= 0) {
    db.splice(index,1);
    saveDB();
    alert("削除しました");
  } else {
    alert("該当データなし");
  }
}

Quagga.init({
  inputStream : {
    name : "Live",
    type : "LiveStream",
    target: document.querySelector('#reader')
  },
  decoder : {
    readers : ["code_128_reader"]
  }
}, function(err) {
    if (err) {
        console.log(err);
        return;
    }
    Quagga.start();
});

Quagga.onDetected(function(data){
  let code = data.codeResult.code;
  handleScan(code);
});
</script>

</body>
</html>
