<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åœ¨åº«ç®¡ç†SPA</title>

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f3f4f6;
  overflow-x:hidden;
}
header{
  background:#111827;
  color:white;
  padding:15px;
  text-align:center;
  font-size:18px;
}
.container{
  padding:15px;
  max-width:900px;
  margin:auto;
}
button{
  width:100%;
  padding:14px;
  margin:6px 0;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
  font-size:16px;
}
button.secondary{background:#6b7280;}
input,textarea{
  width:100%;
  padding:12px;
  margin:6px 0 14px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}
video{
  width:100%;
  border-radius:12px;
  margin-bottom:10px;
}
.card{
  background:white;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.hidden{display:none;}

#loadingOverlay{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  color:white;
  font-size:20px;
  flex-direction:column;
}
.spinner{
  border:6px solid #ccc;
  border-top:6px solid white;
  border-radius:50%;
  width:60px;height:60px;
  animation:spin 1s linear infinite;
  margin-bottom:20px;
}
@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}
@media(min-width:768px){
  button{width:auto;min-width:220px;}
}
</style>
</head>
<body>

<header>åœ¨åº«ç®¡ç†SPA</header>

<div id="loadingOverlay">
  <div class="spinner"></div>
  è§£æä¸­...
</div>

<div class="container">

<div id="home">
  <button onclick="showView('saveBarcode')">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä¿å­˜</button>
  <button onclick="showView('lookupBarcode')">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç…§ä¼š</button>
  <button onclick="showView('apiInfo')">APIæƒ…å ±</button>
</div>

<div id="apiInfo" class="hidden">
  <input id="apiKey" placeholder="Gemini API Key">
  <textarea id="prompt" rows="8"></textarea>
  <button onclick="saveAPI()">ä¿å­˜</button>
  <button class="secondary" onclick="goHome()">æˆ»ã‚‹</button>
</div>

<div id="saveBarcode" class="hidden">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" class="hidden"></canvas>
  <button onclick="captureAndSend('save')">æ’®å½±ã—ã¦è§£æ</button>
  <button class="secondary" onclick="goHome()">æˆ»ã‚‹</button>
</div>

<div id="lookupBarcode" class="hidden">
  <video id="video2" autoplay playsinline></video>
  <canvas id="canvas2" class="hidden"></canvas>
  <button onclick="captureAndSend('lookup')">æ’®å½±ã—ã¦è§£æ</button>
  <button class="secondary" onclick="goHome()">æˆ»ã‚‹</button>
</div>

</div>

<script>

let stream=null;
let currentMode=null;

function showLoading(show){
  document.getElementById("loadingOverlay").style.display=
    show?"flex":"none";
}

function showView(id){
  stopCamera();
  document.querySelectorAll(".container>div")
    .forEach(d=>d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if(id==="saveBarcode") startCamera("video");
  if(id==="lookupBarcode") startCamera("video2");
  if(id==="apiInfo"){
    document.getElementById("apiKey").value=
      localStorage.getItem("apiKey")||"";
    document.getElementById("prompt").value=
      localStorage.getItem("prompt")||"";
  }
}

function goHome(){
  stopCamera();
  showView("home");
}

async function startCamera(videoId){

  const constraints={
    video:{
      facingMode:{ideal:"environment"},
      width:{ideal:3840},
      height:{ideal:2160},
      frameRate:{ideal:60},
      focusMode:"continuous",
      exposureMode:"continuous",
      whiteBalanceMode:"continuous"
    }
  };

  stream=await navigator.mediaDevices.getUserMedia(constraints);
  document.getElementById(videoId).srcObject=stream;
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
}

async function captureAndSend(mode){

  currentMode=mode;

  const key=localStorage.getItem("apiKey");
  const prompt=localStorage.getItem("prompt");

  if(!key){alert("APIã‚­ãƒ¼æœªè¨­å®š");return;}

  const videoEl=mode==="save"
    ?document.getElementById("video")
    :document.getElementById("video2");

  const canvas=mode==="save"
    ?document.getElementById("canvas")
    :document.getElementById("canvas2");

  canvas.width=videoEl.videoWidth;
  canvas.height=videoEl.videoHeight;
  canvas.getContext("2d").drawImage(videoEl,0,0);

  stopCamera();
  showLoading(true);

  const base64=canvas.toDataURL("image/jpeg",0.98).split(",")[1];

  let jsonResult={barcode:null,confidence:0};

  try{
    const res=await fetch(
`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash-lite:generateContent?key=${key}`,
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        contents:[{
          parts:[
            {text:prompt},
            {inline_data:{mime_type:"image/jpeg",data:base64}}
          ]
        }]
      })
    });

    const data=await res.json();
    const text=data.candidates?.[0]?.content?.parts?.[0]?.text;
    jsonResult=JSON.parse(text);

  }catch(e){
    jsonResult={barcode:null,confidence:0,error:"è§£æå¤±æ•—"};
  }

  showLoading(false);

  alert(JSON.stringify(jsonResult,null,2));

  // ğŸ”¥ è§£æå¾Œã‚«ãƒ¡ãƒ©å¾©æ´»
  if(currentMode==="save") startCamera("video");
  if(currentMode==="lookup") startCamera("video2");
}

</script>
</body>
</html>
