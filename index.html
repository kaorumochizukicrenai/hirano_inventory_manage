<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åœ¨åº«ç®¡ç†SPA</title>

<style>
*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f3f4f6;
  overflow-x:hidden;
}

header{
  background:#1f2937;
  color:white;
  padding:15px;
  text-align:center;
  font-size:18px;
}

.container{
  padding:15px;
  max-width:900px;
  margin:auto;
}

button{
  width:100%;
  padding:14px;
  margin:6px 0;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
  font-size:16px;
}

button.secondary{
  background:#6b7280;
}

input,textarea{
  width:100%;
  padding:12px;
  margin:6px 0 14px 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}

video{
  width:100%;
  border-radius:10px;
  margin-bottom:10px;
}

.card{
  background:white;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.hidden{ display:none; }

/* ğŸ”¥ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
#loadingOverlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:20px;
  z-index:9999;
  display:none;
}

.spinner{
  border:6px solid #ccc;
  border-top:6px solid white;
  border-radius:50%;
  width:50px;
  height:50px;
  animation:spin 1s linear infinite;
  margin-bottom:20px;
}

@keyframes spin{
  0%{ transform:rotate(0deg); }
  100%{ transform:rotate(360deg); }
}

@media(min-width:768px){
  button{ width:auto; min-width:220px; }
}
</style>
</head>
<body>

<header>åœ¨åº«ç®¡ç†SPA</header>

<div id="loadingOverlay">
  <div>
    <div class="spinner"></div>
    è§£æä¸­...
  </div>
</div>

<div class="container">

<div id="home">
  <button onclick="showView('viewData')">ãƒ‡ãƒ¼ã‚¿é–²è¦§</button>
  <button onclick="showView('saveBarcode')">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä¿å­˜</button>
  <button onclick="showView('lookupBarcode')">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç…§ä¼š</button>
  <button onclick="showView('apiInfo')">APIæƒ…å ±</button>
</div>

<div id="apiInfo" class="hidden">
  <h3>APIè¨­å®š</h3>
  <input id="apiKey" placeholder="Gemini API Key">
  <textarea id="prompt" rows="10"></textarea>
  <button onclick="saveAPI()">ä¿å­˜</button>
  <button class="secondary" onclick="goHome()">æˆ»ã‚‹</button>
</div>

<div id="saveBarcode" class="hidden">
  <h3>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä¿å­˜</h3>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" class="hidden"></canvas>
  <button onclick="captureAndSend('save')">æ’®å½±ã—ã¦è§£æ</button>

  <input id="category" placeholder="å•†å“ç¨®åˆ¥ï¼ˆå¿…é ˆï¼‰">
  <input id="expiry" type="date">

  <div id="saveResult"></div>
  <button class="secondary" onclick="goHome()">æˆ»ã‚‹</button>
</div>

<div id="lookupBarcode" class="hidden">
  <h3>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç…§ä¼š</h3>
  <video id="video2" autoplay playsinline></video>
  <canvas id="canvas2" class="hidden"></canvas>
  <button onclick="captureAndSend('lookup')">æ’®å½±ã—ã¦è§£æ</button>

  <div id="lookupResult"></div>
  <button class="secondary" onclick="goHome()">æˆ»ã‚‹</button>
</div>

<div id="viewData" class="hidden">
  <h3>ä¿å­˜ãƒ‡ãƒ¼ã‚¿</h3>
  <div id="dataList"></div>
  <button class="secondary" onclick="goHome()">æˆ»ã‚‹</button>
</div>

</div>

<script>

let stream=null;
let inventory=[];
let currentMode=null;

const defaultPrompt=`
ã‚ãªãŸã¯ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è§£æAIã§ã™ã€‚

ãƒ»ä¸æ˜ç¢ºãªã‚‰ null
ãƒ»æ¨æ¸¬ç¦æ­¢
ãƒ»ã¼ã‚„ã‘ã¦ã„ã‚‹å ´åˆã¯ null
ãƒ»ç¢ºå®Ÿã«èª­ã¿å–ã‚ŒãŸæ•°å­—ã®ã¿è¿”ã™

{
 "barcode":"å€¤ or null",
 "confidence":0-1
}
`;

if(!localStorage.getItem("prompt")){
  localStorage.setItem("prompt",defaultPrompt);
}

function showLoading(show){
  document.getElementById("loadingOverlay").style.display=
    show?"flex":"none";
}

function showView(id){
  stopCamera();
  document.querySelectorAll(".container>div")
    .forEach(d=>d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  if(id==="saveBarcode") startCamera("video");
  if(id==="lookupBarcode") startCamera("video2");
  if(id==="viewData") renderData();
  if(id==="apiInfo"){
    document.getElementById("apiKey").value=
      localStorage.getItem("apiKey")||"";
    document.getElementById("prompt").value=
      localStorage.getItem("prompt");
  }
}

function goHome(){
  stopCamera();
  showView("home");
}

async function startCamera(videoId){
  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:"environment"}}
  });
  document.getElementById(videoId).srcObject=stream;
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
}

async function captureAndSend(mode){
  currentMode=mode;

  const key=localStorage.getItem("apiKey");
  const prompt=localStorage.getItem("prompt");

  if(!key){ alert("APIã‚­ãƒ¼æœªè¨­å®š"); return; }

  const videoEl=mode==="save"
    ?document.getElementById("video")
    :document.getElementById("video2");

  const canvas=mode==="save"
    ?document.getElementById("canvas")
    :document.getElementById("canvas2");

  canvas.width=videoEl.videoWidth;
  canvas.height=videoEl.videoHeight;
  canvas.getContext("2d").drawImage(videoEl,0,0);

  stopCamera();
  showLoading(true);

  const base64=canvas.toDataURL("image/jpeg").split(",")[1];

  try{
    const res=await fetch(
    `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash-lite:generateContent?key=${key}`,
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        contents:[{
          parts:[
            {text:prompt},
            {inline_data:{mime_type:"image/jpeg",data:base64}}
          ]
        }]
      })
    });

    const data=await res.json();
    const text=data.candidates?.[0]?.content?.parts?.[0]?.text;
    const json=JSON.parse(text);
    handleResult(json);

  }catch(e){
    alert("è§£æä¸èƒ½");
  }

  showLoading(false);
}

function handleResult(json){

  if(!json.barcode){
    alert("è§£æä¸èƒ½");
    return;
  }

  if(json.confidence<0.8){
    alert("âš  ä¿¡é ¼åº¦ä½: "+json.confidence);
  }

  if(currentMode==="save"){
    const category=document.getElementById("category").value;
    const expiry=document.getElementById("expiry").value;

    if(!category||!expiry){
      alert("ç¨®åˆ¥ã¨æœŸé™å¿…é ˆ");
      return;
    }

    inventory.push({
      barcode:json.barcode,
      category,
      expiry
    });

    document.getElementById("saveResult").innerText=
      "ä¿å­˜å®Œäº†: "+json.barcode;
  }

  if(currentMode==="lookup"){
    const found=inventory.filter(i=>i.barcode===json.barcode);
    if(found.length===0){
      document.getElementById("lookupResult").innerText="è©²å½“ãªã—";
      return;
    }

    const nearest=found.sort((a,b)=>
      new Date(a.expiry)-new Date(b.expiry))[0];

    document.getElementById("lookupResult").innerHTML=
      `æœ€çŸ­æœŸé™: ${nearest.expiry}
       <button onclick="useItem('${nearest.barcode}','${nearest.expiry}')">
       ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹</button>`;
  }
}

function useItem(barcode,expiry){
  inventory=inventory.filter(i=>
    !(i.barcode===barcode&&i.expiry===expiry));
  alert("å‰Šé™¤ã—ã¾ã—ãŸ");
}

function renderData(){
  const el=document.getElementById("dataList");
  el.innerHTML="";
  inventory.forEach((i,idx)=>{
    el.innerHTML+=`
    <div class="card">
      ${i.category}<br>
      ${i.barcode}<br>
      ${i.expiry}
      <button onclick="inventory.splice(${idx},1);renderData()">
      å‰Šé™¤</button>
    </div>`;
  });
}

</script>
</body>
</html>
